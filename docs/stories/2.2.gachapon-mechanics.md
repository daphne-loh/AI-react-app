# Story 2.2: Gachapon Pull Mechanics

## Status
**Current Status:** Draft _(owned by scrum-master, editable by scrum-master, dev-agent)_

## Story

**As a** FoodDrop user,  
**I want** to perform satisfying "pulls" that reveal new food items with exciting animations,  
**so that** I experience the joy and anticipation of collecting new discoveries.

## Acceptance Criteria

1. Gachapon interface with prominent "pull" button and engaging visual design
2. Smooth pull animation sequence with anticipation building and satisfying reveal
3. Random food item selection algorithm with weighted probabilities for different rarities
4. Duplicate handling logic that provides alternative rewards or progress benefits
5. Pull animation optimized for 60fps performance on mobile devices
6. Sound effects and haptic feedback (where supported) for enhanced tactile experience
7. Visual celebration for rare item discoveries and collection milestones
8. Subscription validation before allowing pulls
9. Pull history tracking and analytics
10. Progressive loading and error handling for network issues

## Tasks / Subtasks

- [ ] **Task 1: Gachapon UI Component Development** (AC: 1, 5)
  - [ ] Design and implement gachapon machine visual component
  - [ ] Create prominent, touch-friendly "PULL" button with visual feedback
  - [ ] Implement mobile-optimized layout with proper touch targets
  - [ ] Add loading states and disabled states for the pull button
  - [ ] Optimize animations for 60fps performance on mobile devices
  - [ ] Test touch interactions across different mobile devices

- [ ] **Task 2: Pull Animation System** (AC: 2, 6, 7)
  - [ ] Create multi-stage pull animation sequence (button press → activation → reveal)
  - [ ] Implement anticipation-building animation with proper timing
  - [ ] Add capsule drop and reveal animation with smooth transitions
  - [ ] Create celebration animations for rare item discoveries
  - [ ] Implement sound effects for each animation stage
  - [ ] Add haptic feedback for supported devices
  - [ ] Test animation performance across different device capabilities

- [ ] **Task 3: Random Selection Algorithm** (AC: 3, 4)
  - [ ] Implement weighted random selection based on rarity tiers
  - [ ] Create probability distribution system (common 60%, uncommon 25%, rare 12%, legendary 3%)
  - [ ] Add duplicate detection and alternative reward system
  - [ ] Implement pity timer for guaranteed rare items
  - [ ] Create collection completion bonuses
  - [ ] Add pseudo-random number generation for fairness

- [ ] **Task 4: Backend Pull Logic** (AC: 8, 9)
  - [ ] Create Firebase Cloud Function for gachapon pull processing
  - [ ] Implement subscription status validation
  - [ ] Add pull request authentication and rate limiting
  - [ ] Create pull history tracking and analytics
  - [ ] Implement atomic database operations for collection updates
  - [ ] Add pull result caching for offline scenarios

- [ ] **Task 5: User Collection Integration** (AC: 4, 9)
  - [ ] Update user collection data after successful pulls
  - [ ] Implement real-time collection progress updates
  - [ ] Add duplicate item handling with progress rewards
  - [ ] Create collection completion detection
  - [ ] Update user statistics and achievement progress
  - [ ] Sync collection data across devices

- [ ] **Task 6: Error Handling and Edge Cases** (AC: 10)
  - [ ] Handle network connectivity issues during pulls
  - [ ] Implement retry logic for failed pull operations
  - [ ] Add graceful degradation for animation performance issues
  - [ ] Handle subscription expiration during pull attempts
  - [ ] Create offline mode with cached results
  - [ ] Add proper error messaging for different failure scenarios

## Dev Notes

**Gachapon Mechanics Architecture:**
- **Frontend**: React animations with Framer Motion or Lottie
- **Backend**: Firebase Cloud Functions for pull processing
- **Real-time**: Firestore listeners for collection updates
- **Performance**: Optimized animations with reduced motion support

**Pull Processing Flow:**
```typescript
interface PullRequest {
  userId: string;
  packId?: string; // Optional: specific themed pack
  timestamp: Timestamp;
}

interface PullResult {
  success: boolean;
  foodItem: FoodItem;
  isNew: boolean;
  rarity: string;
  collectionProgress: {
    totalItems: number;
    newTotal: number;
    completedPacks: string[];
  };
  specialRewards?: {
    type: 'completion_bonus' | 'rare_streak' | 'duplicate_reward';
    value: number;
  };
}
```

**Rarity Probability System:**
```typescript
const RARITY_WEIGHTS = {
  common: 0.60,      // 60% chance
  uncommon: 0.25,    // 25% chance  
  rare: 0.12,        // 12% chance
  legendary: 0.03    // 3% chance
};

// Pity timer: Guaranteed rare after 20 pulls without one
const PITY_TIMER_THRESHOLD = 20;
```

**Animation Performance Optimization:**
- Use CSS transforms for smooth animations
- Implement requestAnimationFrame for complex sequences
- Add reduced motion support for accessibility
- Lazy load heavy animation assets
- Use hardware acceleration where available

**Subscription Integration:**
```typescript
// Pull validation function
async function validatePullAccess(userId: string): Promise<boolean> {
  const user = await getUserSubscription(userId);
  return user.subscriptionStatus === 'active';
}
```

**Pull Analytics Tracking:**
```typescript
interface PullAnalytics {
  userId: string;
  timestamp: Timestamp;
  result: 'success' | 'duplicate' | 'error';
  rarity: string;
  packId?: string;
  sessionId: string;
  deviceInfo: {
    platform: string;
    browser: string;
    connectionType: string;
  };
}
```

**Sound and Haptic Implementation:**
- Web Audio API for sound effects
- Vibration API for haptic feedback
- Progressive enhancement approach
- User preference controls for audio/haptic
- Respectful of user system settings

### Testing

**Animation Performance Testing:**
- 60fps animation verification on target mobile devices
- Battery usage optimization during extended animation sequences
- Memory leak prevention in animation loops
- Smooth performance degradation on lower-end devices
- Animation consistency across different screen sizes

**Pull Algorithm Testing:**
- Statistical verification of rarity probability distribution
- Pity timer functionality validation across multiple scenarios
- Duplicate handling logic verification
- Collection completion detection accuracy
- Edge case handling for empty or invalid content packs

**Integration Testing:**
- Real-time collection updates propagate correctly
- Subscription validation prevents unauthorized pulls
- Firebase Cloud Function performance under load
- Offline scenario handling and data synchronization
- Cross-device collection state consistency

**User Experience Testing:**
- Pull satisfaction and engagement measurement
- Animation timing optimization for maximum impact
- Touch responsiveness across different mobile devices
- Accessibility compliance for users with motion sensitivities
- Sound and haptic feedback preference handling

**Load Testing:**
- Concurrent pull request handling
- Database performance under high pull volume
- Animation performance with multiple simultaneous users
- Resource usage optimization during peak activity
- Graceful degradation under system stress

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-22 | 1.0 | Initial story creation for gachapon pull mechanics | Sarah (PO) |

## Dev Agent Record
_(This section is owned by dev-agent and can only be modified by dev-agent)_

## QA Results
_(This section is owned by qa-agent and can only be modified by qa-agent)_